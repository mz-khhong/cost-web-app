name: Deploy to Lightsail

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Gradle
        run: ./gradlew clean build -x test
      - name: Rename JAR with deployment number
        run: |
          DEPLOY_NUMBER=${{ github.run_number }}
          echo "=== Deployment number: $DEPLOY_NUMBER ==="
          JAR_FILE=$(ls build/libs/cost-web-app-*.jar 2>/dev/null | grep -v plain | head -1)
          if [ -n "$JAR_FILE" ]; then
            NEW_NAME="cost-web-app-0.0.1-SNAPSHOT-${DEPLOY_NUMBER}.jar"
            mv "$JAR_FILE" "build/libs/$NEW_NAME"
            echo "Renamed from: $(basename $JAR_FILE)"
            echo "Renamed to: $NEW_NAME"
            echo "Deployment number: $DEPLOY_NUMBER"
          else
            echo "ERROR: JAR file not found for renaming"
            ls -la build/libs/ || echo "build/libs directory not found"
            exit 1
          fi
      - name: Debug build folder
        run: |
          echo "=== build/libs directory structure ==="
          ls -lh build/libs/*.jar || echo "No jar files found"
          echo ""
          echo "=== Files to deploy ==="
          ls -lh build/libs/cost-web-app-0.0.1-SNAPSHOT-*.jar || echo "No deployment numbered files found"

      - name: Deploy to Lightsail Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY_DEV }}
          source: build/libs/cost-web-app-0.0.1-SNAPSHOT-*.jar
          target: /home/ubuntu/cost-web-app/

      - name: Setup and Restart Service on Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY_DEV }}
          envs: DEPLOY_NUMBER=${{ github.run_number }}
          script: |
            echo "=== Deployment number: $DEPLOY_NUMBER ==="
            # 디버깅: 전송된 파일 확인
            echo "=== Checking transferred files ==="
            echo "Files in root directory:"
            ls -la /home/ubuntu/cost-web-app/*.jar 2>/dev/null || echo "No jar files found in root"
            echo ""
            echo "All JAR files in cost-web-app (recursive):"
            find /home/ubuntu/cost-web-app -name "*.jar" -type f 2>/dev/null | head -10 || echo "No jar files found"
            
            # JAR 파일을 올바른 위치로 이동
            mkdir -p /home/ubuntu/cost-web-app/build/libs
            
            # 기존 JAR 파일 모두 제거 (중복 방지)
            # 오래된 중첩된 경로도 정리
            rm -rf /home/ubuntu/cost-web-app/build/libs/build
            rm -f /home/ubuntu/cost-web-app/build/libs/*.jar
            
            # 새 JAR 파일 찾기 (배포 번호가 포함된 JAR 파일 우선)
            # 파일명 형식: cost-web-app-0.0.1-SNAPSHOT-{배포번호}.jar
            echo ""
            echo "=== Looking for deployment numbered JAR (Number: $DEPLOY_NUMBER) ==="
            
            # 배포 번호로 정확한 파일명 찾기
            EXPECTED_JAR="cost-web-app-0.0.1-SNAPSHOT-${DEPLOY_NUMBER}.jar"
            JAR_SOURCE=$(find /home/ubuntu/cost-web-app -maxdepth 1 -name "$EXPECTED_JAR" -type f 2>/dev/null | head -1)
            
            # 정확한 파일명이 없으면 패턴으로 찾기
            if [ -z "$JAR_SOURCE" ]; then
              echo "Exact file not found, searching by pattern..."
              JAR_SOURCE=$(find /home/ubuntu/cost-web-app -maxdepth 1 -name "cost-web-app-0.0.1-SNAPSHOT-*.jar" -type f 2>/dev/null | grep -v plain | head -1)
            fi
            
            # 배포 번호가 포함된 파일이 없으면 일반 파일 찾기
            if [ -z "$JAR_SOURCE" ]; then
              echo "Deployment numbered JAR not found, looking for regular JAR..."
              JAR_SOURCE=$(find /home/ubuntu/cost-web-app -maxdepth 1 -name "cost-web-app-*.jar" -type f ! -name "*-plain.jar" 2>/dev/null | head -1)
            fi
            
            if [ -n "$JAR_SOURCE" ]; then
              echo "Found JAR file: $JAR_SOURCE"
              # 새 JAR 파일 이동
              mv "$JAR_SOURCE" /home/ubuntu/cost-web-app/build/libs/
              echo "JAR file moved to build/libs/"
            else
              echo "WARNING: JAR file not found in root"
            fi
            
            # JAR 파일 확인 (최종 위치)
            # 배포 번호가 포함된 파일 우선, 없으면 일반 파일
            echo ""
            echo "=== Finding JAR file for service (Expected: $EXPECTED_JAR) ==="
            
            # 배포 번호로 정확한 파일명 찾기
            JAR_FILE=$(find /home/ubuntu/cost-web-app/build/libs -name "$EXPECTED_JAR" -type f 2>/dev/null | head -1)
            
            # 정확한 파일명이 없으면 패턴으로 찾기
            if [ -z "$JAR_FILE" ]; then
              echo "Exact file not found, searching by pattern..."
              JAR_FILE=$(find /home/ubuntu/cost-web-app/build/libs -name "cost-web-app-0.0.1-SNAPSHOT-*.jar" -type f 2>/dev/null | grep -v plain | head -1)
            fi
            
            if [ -z "$JAR_FILE" ]; then
              echo "Deployment numbered JAR not found, looking for regular JAR..."
              JAR_FILE=$(find /home/ubuntu/cost-web-app/build/libs -name "cost-web-app-*.jar" -type f ! -name "*-plain.jar" 2>/dev/null | head -1)
            fi
            if [ -z "$JAR_FILE" ]; then
              echo "ERROR: JAR file not found in build/libs/"
              echo "Files in build/libs/:"
              ls -la /home/ubuntu/cost-web-app/build/libs/ || echo "Directory does not exist"
              exit 1
            fi
            echo "JAR file found: $JAR_FILE"
            
            # systemd 서비스 파일 생성 또는 업데이트
            echo "=== Creating/Updating systemd service file ==="
            sudo tee /etc/systemd/system/cost-web-app.service > /dev/null <<SERVICEEOF
            [Unit]
            Description=Cost Web App
            After=network.target

            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/home/ubuntu/cost-web-app
            ExecStart=/usr/bin/java -jar $JAR_FILE
            Restart=always
            RestartSec=10
            StandardOutput=journal
            StandardError=journal

            Environment="SERVER_PORT=8080"

            [Install]
            WantedBy=multi-user.target
            SERVICEEOF
            
            # 항상 daemon-reload 실행 (서비스 파일 변경 시)
            sudo systemctl daemon-reload
            sudo systemctl enable cost-web-app
            
            # 서비스 재시작
            sudo systemctl restart cost-web-app
            
            # 애플리케이션 시작 대기 (최대 30초)
            echo "Waiting for application to start..."
            for i in {1..30}; do
              if curl -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "Application is ready!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "ERROR: Application failed to start within 30 seconds"
                sudo systemctl status cost-web-app --no-pager
                exit 1
              fi
              sleep 1
            done
            
            echo "=== Service Status ==="
            sudo systemctl status cost-web-app --no-pager | head -20
            echo ""
            echo "=== Health Check ==="
            curl -f http://localhost:8080/api/health || exit 1
            echo ""
            echo "=== Deployment completed successfully ==="

