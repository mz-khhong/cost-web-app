<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Solution Site</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/login.css}">
</head>
<body class="loading">
    <!-- 초기 로딩 애니메이션 -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-logo">AI Solution Site</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
    <!-- 네비게이션 바 (상단 고정) - 버튼들 -->
    <nav class="navbar">
      <div class="navbar-menu">
        <button class="navbar-button" onclick="showComponent('login', this)">로그인</button>
        <button class="navbar-button" onclick="showComponent('health', this)">Health Check API</button>
        <button class="navbar-button" onclick="showComponent('actuator', this)">Actuator Health</button>
        <button class="navbar-button" onclick="showComponent('prometheus', this)">Prometheus Metrics</button>
        <button class="navbar-button" onclick="showComponent('logs', this)">로그</button>
      </div>
    </nav>

    <div class="container">
      <!-- 동적으로 로드되는 컴포넌트 영역 -->
      <div id="component-container"></div>
    </div>

    </div>
    <!-- 메인 콘텐츠 끝 -->
    <!-- Footer 바 (최하단 고정) -->
    <footer class="footer-bar">
        <div class="footer-content">
            <div class="footer-left">
                <div class="footer-info">
                    <span class="status-indicator"></span>
                    <span class="footer-info-label">상태:</span>
                    <span class="footer-info-value" th:text="${status}">UP</span>
                </div>
                <span class="footer-divider">|</span>
                <div class="footer-info">
                    <span class="footer-info-label">시간:</span>
                    <span class="footer-info-value" th:text="${currentTime}">2024-01-01 12:00:00</span>
                </div>
                <span class="footer-divider">|</span>
                <div class="footer-info">
                    <span class="footer-info-label">IP:</span>
                    <span class="footer-info-value" th:text="${clientIp}">192.168.1.1</span>
                </div>
                <span class="footer-divider">|</span>
                <div class="footer-info">
                    <span class="footer-info-label">호스트:</span>
                    <span class="footer-info-value" th:text="${remoteHost}">localhost</span>
                </div>
                <span class="footer-divider">|</span>
                <div class="footer-info">
                    <span class="footer-info-label">세션:</span>
                    <span class="footer-info-value" th:text="${sessionId}">session-id</span>
                </div>
                <span class="footer-divider">|</span>
                <div class="footer-info">
                    <span class="footer-info-label">서버:</span>
                    <span class="footer-info-value" th:text="${serverName + ':' + serverPort}">localhost:8080</span>
                </div>
                <span class="footer-divider">|</span>
                <div class="footer-info">
                    <span class="footer-info-label">언어:</span>
                    <span class="footer-info-value" th:text="${acceptLanguage}">ko-KR</span>
                </div>
            </div>
            <div class="footer-bottom">
                Service Develop
            </div>
        </div>
    </footer>

    <script>
        // 초기 로딩 애니메이션
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loader = document.getElementById('pageLoader');
                const body = document.body;
                const mainContent = document.querySelector('.main-content');
                
                loader.classList.add('hidden');
                body.classList.remove('loading');
                
                setTimeout(function() {
                    mainContent.classList.add('loaded');
                    document.querySelector('.navbar').classList.add('navbar-visible');
                }, 100);
            }, 1500); // 1.5초 후 로딩 화면 숨김
        });
        // 현재 표시된 컴포넌트 추적
        let currentComponent = null;

        function showComponent(componentName, buttonElement) {
            // 모든 버튼에서 active 클래스 제거
            document.querySelectorAll('.navbar-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // 현재 버튼 활성화
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            const componentContainer = document.getElementById('component-container');
            if (!componentContainer) return;

            // 컴포넌트 URL 매핑
            const componentUrls = {
                'login': '/components/login',
                'health': '/components/health',
                'actuator': '/components/actuator',
                'prometheus': '/components/prometheus',
                'logs': '/components/logs'
            };
            
            const componentUrl = componentUrls[componentName];
            if (!componentUrl) {
                console.error('Unknown component:', componentName);
                return;
            }
            
            // 로딩 표시
            componentContainer.innerHTML = '<div class="hidden-component show"><div class="loading">로딩 중</div></div>';
            
            // 컴포넌트 로드
            fetch(componentUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // 컴포넌트 HTML 추출 (body 내용)
                    const componentHTML = doc.body.innerHTML;
                    
                    // 컴포넌트를 hidden-component로 감싸서 표시
                    componentContainer.innerHTML = '<div class="hidden-component show">' + componentHTML + '</div>';
                    
                    // 컴포넌트 내용 로드
                    const componentElement = componentContainer.querySelector('.hidden-component');
                    if (componentElement) {
                        const contentElement = componentElement.querySelector('.component-content');
                        if (contentElement) {
                            loadComponentContent(componentName, contentElement);
                        }
                    }
                    
                    currentComponent = componentName;
                })
                .catch(error => {
                    console.error('Error loading component:', error);
                    componentContainer.innerHTML = '<div class="hidden-component show"><div style="color: #dc3545; padding: 40px; text-align: center;">' +
                        '<strong style="font-size: 1.2em; display: block; margin-bottom: 15px;">오류가 발생했습니다</strong>' +
                        '<div style="margin-top: 15px; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">' +
                        '<div style="margin-bottom: 10px;">' + error.message + '</div>' +
                        '<div style="font-size: 0.9em; opacity: 0.8;">URL: ' + componentUrl + '</div>' +
                        '</div></div></div>';
                });
        }

        function hideComponent(componentName) {
            const componentContainer = document.getElementById('component-container');
            if (componentContainer) {
                componentContainer.innerHTML = '';
            }

            // 모든 버튼에서 active 클래스 제거
            document.querySelectorAll('.navbar-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            currentComponent = null;
        }

        function loadComponentContent(componentName, contentElement) {
            // 로딩 표시
            contentElement.innerHTML = '<div class="loading">로딩 중</div>';

            let url = '';
            let isJson = false;

            switch(componentName) {
                case 'login':
                    // 로그인 폼을 AJAX로 로드하여 스타일 조정
                    fetch('/login')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                            }
                            return response.text();
                        })
                        .then(html => {
                            // HTML에서 로그인 컨테이너만 추출
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const loginContainer = doc.querySelector('.login-container');
                            
                            if (!loginContainer) {
                                throw new Error('로그인 폼을 찾을 수 없습니다.');
                            }
                            
                            // 로그인 제목 제거 (component-header에 이미 있음)
                            const title = loginContainer.querySelector('.login-title');
                            if (title) {
                                title.remove();
                            }
                            
                            // 컨테이너 내용 가져오기
                            let containerContent = loginContainer.innerHTML;
                            
                            // 어두운 테마에 맞게 스타일 조정된 로그인 폼
                            contentElement.innerHTML = `
                                <div style="display: flex; justify-content: center; align-items: flex-start; min-height: 100%; padding: 40px 20px;">
                                    <div class="login-container" style="
                                        position: relative;
                                        background: rgba(255, 255, 255, 0.08);
                                        backdrop-filter: blur(15px);
                                        border: 1px solid rgba(255, 255, 255, 0.15);
                                        border-radius: 16px;
                                        padding: 40px;
                                        max-width: 450px;
                                        width: 100%;
                                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                                    ">
                                        <div class="loading-overlay" id="loginLoading">
                                            <div class="spinner"></div>
                                        </div>
                                        <div class="error-message" id="loginErrorMessage" style="display: none;"></div>
                                        <div class="success-message" id="loginSuccessMessage" style="display: none;"></div>
                                        ${containerContent}
                                    </div>
                                </div>
                            `;
                            
                            // 폼 이벤트 바인딩 (AJAX 로그인 처리)
                            setTimeout(() => {
                                const loginForm = contentElement.querySelector('#loginForm');
                                const errorMsg = contentElement.querySelector('#loginErrorMessage');
                                const successMsg = contentElement.querySelector('#loginSuccessMessage');
                                const loadingOverlay = contentElement.querySelector('#loginLoading');
                                
                                if (loginForm) {
                                    // 기존 이벤트 리스너 제거 (중복 방지)
                                    const newForm = loginForm.cloneNode(true);
                                    loginForm.parentNode.replaceChild(newForm, loginForm);
                                    
                                    // 새 폼에 이벤트 리스너 추가
                                    newForm.addEventListener('submit', async function(e) {
                                        e.preventDefault();
                                        
                                        // 에러/성공 메시지 숨기기
                                        if (errorMsg) errorMsg.style.display = 'none';
                                        if (successMsg) successMsg.style.display = 'none';
                                        
                                        // 로딩 표시
                                        if (loadingOverlay) loadingOverlay.classList.add('show');
                                        
                                        const submitButton = newForm.querySelector('.login-button');
                                        if (submitButton) {
                                            submitButton.disabled = true;
                                            const originalText = submitButton.textContent;
                                            submitButton.textContent = '로그인 중...';
                                            
                                            // FormData 생성
                                            const formData = new FormData(newForm);
                                            
                                            try {
                                                const response = await fetch('/login', {
                                                    method: 'POST',
                                                    body: formData,
                                                    headers: {
                                                        'X-Requested-With': 'XMLHttpRequest'
                                                    }
                                                });
                                                
                                                const responseText = await response.text();
                                                
                                                // HTML 응답 파싱 (리다이렉트 또는 에러 페이지)
                                                const parser = new DOMParser();
                                                const doc = parser.parseFromString(responseText, 'text/html');
                                                
                                                // 리다이렉트 체크 (Location 헤더 또는 302 상태)
                                                if (response.redirected || response.url.includes('/') && response.status === 200) {
                                                    // 로딩 숨기기
                                                    if (loadingOverlay) loadingOverlay.classList.remove('show');
                                                    if (submitButton) {
                                                        submitButton.disabled = false;
                                                        submitButton.textContent = originalText;
                                                    }
                                                    
                                                    // 성공 다이얼로그 표시
                                                    showLoginSuccessDialog();
                                                } else {
                                                    // 에러 메시지 확인
                                                    const errorElement = doc.querySelector('.error-message');
                                                    if (errorElement && errorElement.textContent.trim()) {
                                                        if (errorMsg) {
                                                            errorMsg.textContent = errorElement.textContent.trim();
                                                            errorMsg.style.display = 'block';
                                                        }
                                                    } else {
                                                        if (errorMsg) {
                                                            errorMsg.textContent = '로그인에 실패했습니다. ID와 비밀번호를 확인해주세요.';
                                                            errorMsg.style.display = 'block';
                                                        }
                                                    }
                                                    
                                                    // 로딩 숨기기
                                                    if (loadingOverlay) loadingOverlay.classList.remove('show');
                                                    if (submitButton) {
                                                        submitButton.disabled = false;
                                                        submitButton.textContent = originalText;
                                                    }
                                                }
                                            } catch (error) {
                                                console.error('Login error:', error);
                                                if (errorMsg) {
                                                    errorMsg.textContent = '로그인 중 오류가 발생했습니다. 다시 시도해주세요.';
                                                    errorMsg.style.display = 'block';
                                                }
                                                if (loadingOverlay) loadingOverlay.classList.remove('show');
                                                if (submitButton) {
                                                    submitButton.disabled = false;
                                                    submitButton.textContent = originalText;
                                                }
                                            }
                                        }
                                    });
                                    
                                    // SNS 로그인 버튼 이벤트 바인딩 (GitHub 제외)
                                    const snsButtons = contentElement.querySelectorAll('.sns-button');
                                    snsButtons.forEach(button => {
                                        button.addEventListener('click', function() {
                                            const provider = this.classList.contains('google') ? 'google' :
                                                          this.classList.contains('kakao') ? 'kakao' :
                                                          this.classList.contains('naver') ? 'naver' : '';
                                            if (provider) {
                                                handleSnsLogin(provider);
                                            }
                                        });
                                    });
                                }
                            }, 100);
                        })
                        .catch(error => {
                            console.error('Error loading login:', error);
                            contentElement.innerHTML = '<div style="color: #dc3545; padding: 40px; text-align: center;">' +
                                '<strong style="font-size: 1.2em; display: block; margin-bottom: 15px;">오류가 발생했습니다</strong>' +
                                '<div style="margin-top: 15px; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">' +
                                '<div style="margin-bottom: 10px;">' + error.message + '</div>' +
                                '<div style="font-size: 0.9em; opacity: 0.8;">URL: /login</div>' +
                                '</div></div>';
                        });
                    return;
                
                case 'health':
                    url = '/api/health';
                    isJson = true;
                    break;
                
                case 'actuator':
                    url = '/actuator/health';
                    isJson = true;
                    break;
                
                case 'prometheus':
                    url = '/actuator/prometheus';
                    isJson = false;
                    break;
                
                case 'logs':
                    url = '/api/logs?lines=100';
                    isJson = true;
                    break;
            }

            // AJAX로 데이터 가져오기
            fetch(url)
                .then(response => {
                    // 응답 상태 확인
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // Content-Type 확인
                    const contentType = response.headers.get('content-type');
                    
                    if (componentName === 'prometheus') {
                        // Prometheus는 텍스트 형식
                        return response.text();
                    } else if (contentType && contentType.includes('application/json')) {
                        // JSON 형식인 경우
                        return response.json();
                    } else {
                        // JSON이 아닌 경우 텍스트로 받기
                        return response.text().then(text => {
                            // HTML 에러 페이지인지 확인
                            if (text.trim().startsWith('<')) {
                                throw new Error('서버에서 HTML 응답을 반환했습니다. 엔드포인트가 올바르게 설정되었는지 확인하세요.');
                            }
                            // JSON처럼 보이지만 Content-Type이 없는 경우
                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                throw new Error('응답을 JSON으로 파싱할 수 없습니다.');
                            }
                        });
                    }
                })
                .then(data => {
                    if (componentName === 'logs') {
                        // 로그 데이터 처리 (Prometheus처럼 텍스트 형식으로 표시)
                        if (data && data.success && data.logs && Array.isArray(data.logs)) {
                            // 로그를 텍스트 형식으로 변환
                            const logText = data.logs.join('\n');
                            contentElement.innerHTML = '<pre>' + logText + '</pre>';
                        } else {
                            // 에러 메시지 표시
                            const errorMsg = data && data.error ? data.error : '로그를 불러올 수 없습니다.';
                            contentElement.innerHTML = '<div style="color: #dc3545; padding: 40px; text-align: center;">' +
                                '<strong style="font-size: 1.2em; display: block; margin-bottom: 15px;">오류가 발생했습니다</strong>' +
                                '<div style="margin-top: 15px; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">' +
                                '<div style="margin-bottom: 10px;">' + errorMsg + '</div>' +
                                '</div></div>';
                        }
                    } else if (isJson) {
                        // JSON 데이터를 보기 좋게 포맷팅
                        contentElement.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    } else {
                        // 텍스트 데이터 (Prometheus)
                        contentElement.innerHTML = '<pre>' + data + '</pre>';
                    }
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    let errorMessage = error.message || '알 수 없는 오류가 발생했습니다.';
                    let errorTitle = '오류가 발생했습니다';
                    
                    // 네트워크 에러 또는 404 에러 처리
                    if (error.message && error.message.includes('404')) {
                        errorTitle = '서버를 찾을 수 없습니다';
                        errorMessage = '서버가 실행되지 않았거나 엔드포인트가 존재하지 않습니다. 서버가 실행 중인지 확인하세요.';
                    } else if (error.message && error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorTitle = '서버 연결 실패';
                        errorMessage = '서버에 연결할 수 없습니다. 서버가 실행 중인지 확인하세요. (http://localhost:8080)';
                    } else if (error.message && error.message.includes('Unexpected token')) {
                        errorMessage = '서버 응답 형식이 올바르지 않습니다. API 엔드포인트가 정상적으로 작동하는지 확인하세요.';
                    }
                    
                    contentElement.innerHTML = '<div style="color: #dc3545; padding: 40px; text-align: center;">' +
                        '<strong style="font-size: 1.3em; display: block; margin-bottom: 20px;">' + errorTitle + '</strong>' +
                        '<div style="margin-top: 15px; padding: 20px; background: rgba(220, 53, 69, 0.1); border-radius: 12px; border: 1px solid rgba(220, 53, 69, 0.3); max-width: 600px; margin: 20px auto;">' +
                        '<div style="margin-bottom: 15px; font-size: 1.1em;">' + errorMessage + '</div>' +
                        '<div style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">URL: ' + url + '</div>' +
                        '<div style="font-size: 0.85em; opacity: 0.7; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(220, 53, 69, 0.2);">' +
                        '서버 실행 확인: <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">./gradlew bootRun</code> 또는 IDE에서 실행' +
                        '</div></div></div>';
                });
        }


        // ESC 키로 컴포넌트 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && currentComponent) {
                hideComponent(currentComponent);
            }
        });

        // SNS 로그인 처리 함수 (전역)
        function handleSnsLogin(provider) {
            console.log(`${provider} 로그인 시도`);
            // TODO: 실제 SNS 연동 로직 구현
            // 예시:
            // window.location.href = `/oauth2/authorization/${provider}`;
            // 또는
            // window.open(`/api/auth/${provider}`, '_blank', 'width=500,height=600');
            
            const providerNames = {
                'google': 'Google',
                'kakao': 'Kakao',
                'naver': 'Naver'
            };
            
            const providerName = providerNames[provider] || provider;
            showInfoDialog(`${providerName} 로그인`, `${providerName} 로그인 기능은 준비 중입니다.`);
        }

        // 로그인 성공 다이얼로그 표시 함수
        function showLoginSuccessDialog() {
            showInfoDialog('로그인 성공', '로그인에 성공했습니다.', 'success');
        }

        // 정보 다이얼로그 표시 함수 (공통)
        function showInfoDialog(title, message, type = 'info') {
            // 기존 다이얼로그 제거
            const existingDialog = document.querySelector('.info-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            // 아이콘과 스타일 결정
            let icon = 'ℹ';
            let iconClass = 'info';
            if (type === 'success') {
                icon = '✓';
                iconClass = 'success';
            }
            
            // 다이얼로그 생성
            const dialog = document.createElement('div');
            dialog.className = 'info-dialog';
            dialog.innerHTML = `
                <div class="info-dialog-content">
                    <div class="info-dialog-icon ${iconClass}">${icon}</div>
                    <div class="info-dialog-title">${title}</div>
                    <div class="info-dialog-message">${message}</div>
                    <button class="info-dialog-button" onclick="this.closest('.info-dialog').remove()">확인</button>
                </div>
            `;
            document.body.appendChild(dialog);
            
            // 3초 후 자동으로 닫기 (성공일 경우만)
            if (type === 'success') {
                setTimeout(() => {
                    if (dialog.parentNode) {
                        dialog.remove();
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>

